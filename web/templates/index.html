<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Available Inventory</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        .car-card { border: 1px solid #ccc; margin: 10px; padding: 10px; }
        .success-msg { color: green; font-weight: bold; }
    </style>
</head>
<body>

<h1>Current Inventory</h1>

<div class="inventory-container">
    {{ range .Cars }}
    <div class="car-card">
        <h3>{{ .Make }} {{ .Model }}</h3>
        <p>Price: ${{ .PriceUSD }}</p>
        <p>Status: {{ .Status }}</p>
    </div>
    {{ else }}
    <p>No cars available at the moment.</p>
    {{ end }}
</div>

<hr>

<div id="vue-app">
    <h2>Request a Test Drive</h2>

    <p v-if="message" class="success-msg">[[ message ]]</p>

    <form @submit.prevent="submitLead" v-if="!message">
        <label>CarModel Model:</label>
        <input type="text" v-model="form.car_model" required><br><br>

        <label>Your Name:</label>
        <input type="text" v-model="form.name" required><br><br>

        <label>Your Phone:</label>
        <input type="text" v-model="form.phone" required><br><br>

        <button type="submit" :disabled="loading">
            [[ loading ? 'Submitting...' : 'Request' ]]
        </button>
    </form>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        compilerOptions: {
            delimiters: ['[[', ']]']
        },
        data() {
            return {
                form: {
                    car_id: '',
                    name: '',
                    phone: ''
                },
                loading: false,
                message: ''
            }
        },
        methods: {
            async submitLead() {
                this.loading = true;
                this.message = '';

                try {
                    const response = await fetch('/api/lead', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.form)
                    });

                    // 1. Read the raw text from the server FIRST, instead of forcing JSON
                    const rawText = await response.text();
                    console.log("Raw Server Response:", rawText);

                    // 2. Safely try to convert it to JSON
                    let data;
                    try {
                        data = JSON.parse(rawText);
                    } catch (jsonError) {
                        // If it fails, the server sent plain text/HTML (like a 404 error)
                        alert("Server Error (Not JSON): " + rawText);
                        return; // Stop execution
                    }

                    // 3. Normal logic if JSON was valid
                    if (response.ok) {
                        this.message = data.message || "Success!";
                        this.form = { car_id: '', name: '', phone: '' };
                    } else {
                        alert("Error: " + (data.error || "Unknown error"));
                    }
                } catch (error) {
                    console.error("Network/JS Error:", error);
                } finally {
                    this.loading = false;
                }
            }
        }
    }).mount('#vue-app');
</script>

</body>
</html>